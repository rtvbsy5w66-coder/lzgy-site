name: CI/CD Pipeline

on:
  push:
    branches: [main-for-vercel, develop]
  pull_request:
    branches: [main-for-vercel, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==========================================
  # BUILD & TYPE CHECKING
  # ==========================================
  build:
    name: üèóÔ∏è Build & Type Check
    runs-on: ubuntu-latest
    
    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4
        
      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: üì• Install dependencies
        run: npm ci
        
      - name: üîç Type checking
        run: npm run type-check
        
      - name: üèóÔ∏è Build application
        run: |
          echo "üèóÔ∏è Starting Next.js build..."
          npm run build || BUILD_FAILED=true
          
          echo "üìä Build completion status: ${BUILD_FAILED:-'SUCCESS'}"
          
          if [ -d ".next" ]; then
            echo "‚úÖ .next directory created successfully"
            echo "üìÅ .next directory contents:"
            ls -la .next/
            echo "üìè .next directory size:"
            du -sh .next/
          else
            echo "‚ùå .next directory not found!"
            echo "üìÅ Current directory contents:"
            ls -la
          fi
          
          # Exit with error if build failed
          if [ "$BUILD_FAILED" = "true" ]; then
            echo "üí• Build failed - exiting"
            exit 1
          fi
        env:
          SKIP_ENV_VALIDATION: true
          NODE_ENV: production
          DATABASE_URL: "mysql://dummy:dummy@localhost:3306/dummy"
          NEXTAUTH_SECRET: "dummy-secret-for-build"
          NEXTAUTH_URL: "https://example.com"
          NEXT_PUBLIC_BASE_URL: "https://example.com"
          
      - name: üì§ Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always() && hashFiles('.next/**/*')
        with:
          name: build-output
          path: .next/
          retention-days: 1
          if-no-files-found: ignore

  # ==========================================
  # CODE QUALITY & LINTING
  # ==========================================
  lint:
    name: üßπ Code Quality & Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4
        
      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: üì• Install dependencies
        run: npm ci
        
      - name: üßπ Run ESLint
        run: npm run lint
        
      - name: üìä ESLint Report
        if: failure()
        run: |
          echo "::warning::ESLint found issues. Please fix them before merging."
          echo "Run 'npm run lint' locally to see detailed errors."

  # ==========================================
  # TESTING
  # ==========================================
  test:
    name: üß™ Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4
        
      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: üì• Install dependencies
        run: npm ci
          
      - name: üß™ Run Jest tests
        run: npm run test:coverage
        env:
          SKIP_ENV_VALIDATION: true
          
      - name: üìä Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

  # ==========================================
  # SECURITY AUDIT
  # ==========================================
  security:
    name: üîí Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4
        
      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: üîç Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true
        
      - name: üìã Security Summary
        if: failure()
        run: |
          echo "::warning::Security vulnerabilities found. Please review:"
          npm audit --audit-level=moderate || true
          echo "Run 'npm audit fix' to automatically fix issues."

  # ==========================================
  # BUNDLE SIZE ANALYSIS
  # ==========================================
  analyze-bundle:
    name: üì¶ Bundle Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4
        
      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: üì• Install dependencies
        run: npm ci
          
      - name: üèóÔ∏è Build for bundle analysis
        run: npm run build
        env:
          SKIP_ENV_VALIDATION: true
          NODE_ENV: production
          DATABASE_URL: "mysql://dummy:dummy@localhost:3306/dummy"
          NEXTAUTH_SECRET: "dummy-secret-for-build"
          NEXTAUTH_URL: "https://example.com"
          NEXT_PUBLIC_BASE_URL: "https://example.com"
          
      - name: üìä Analyze bundle size
        run: |
          echo "üì¶ Bundle size analysis:"
          echo "=========================="
          
          if [ -d ".next" ]; then
            echo "Total .next directory size:"
            du -sh .next/
            
            echo ""
            echo "Static assets size:"
            du -sh .next/static/ || echo "No static directory found"
            
            echo ""
            echo "Large files (>500KB):"
            find .next/static -type f -size +500k -exec ls -lh {} \; 2>/dev/null | awk '{print "üö® " $5 " - " $9}' || echo "‚úÖ No large files found"
            
            echo ""
            echo "JavaScript chunks:"
            find .next/static/chunks -name "*.js" -exec du -h {} \; 2>/dev/null | sort -hr | head -10 || echo "No chunks found"
          else
            echo "‚ùå Build directory not found - bundle analysis failed"
            echo "üìÅ Current directory contents:"
            ls -la
          fi

  # ==========================================
  # PREVIEW DEPLOYMENT (PR only)
  # ==========================================
  deploy-preview:
    name: üöÄ Deploy Preview
    runs-on: ubuntu-latest
    needs: [lint, test]
    if: github.event_name == 'pull_request'
    
    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4
        
      - name: üöÄ Deploy to Vercel Preview
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--env SKIP_ENV_VALIDATION=true'
        id: vercel-preview
        
      - name: üìù Comment Preview URL
        if: success()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üöÄ Preview deployment ready!\n\nüîó **Preview URL:** ${{ steps.vercel-preview.outputs.preview-url }}\n\n*Deployed from commit: ${{ github.sha }}*`
            })

  # ==========================================
  # PRODUCTION DEPLOYMENT (main branch only)
  # ==========================================
  deploy-production:
    name: üöÄ Deploy Production
    runs-on: ubuntu-latest
    needs: [lint, test, security]
    if: github.ref == 'refs/heads/main-for-vercel' && github.event_name == 'push'
    environment: production
    
    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4
        
      - name: üöÄ Deploy to Vercel Production
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod --env SKIP_ENV_VALIDATION=true'
        id: vercel-production

  # ==========================================
  # HEALTH CHECK (after production deploy)
  # ==========================================
  health-check:
    name: üè• Health Check
    runs-on: ubuntu-latest
    needs: deploy-production
    if: github.ref == 'refs/heads/main-for-vercel'
    
    steps:
      - name: ‚è≥ Wait for deployment
        run: sleep 30
        
      - name: üè• Check site health
        run: |
          echo "üè• Checking site health..."
          echo "=========================="
          
          # Production URL (update this to your actual domain)
          URL="https://lovas-political-site-fixed-80xah7hpe.vercel.app"
          
          # Check main page
          echo "üîç Checking homepage..."
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL")
          
          if [ $STATUS -eq 200 ]; then
            echo "‚úÖ Homepage is accessible (Status: $STATUS)"
          else
            echo "‚ùå Homepage failed (Status: $STATUS)"
            exit 1
          fi
          
          # Check critical API endpoints
          echo ""
          echo "üîç Checking API endpoints..."
          
          # Posts API
          POSTS_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL/api/posts?status=PUBLISHED&limit=3")
          if [ $POSTS_STATUS -eq 200 ]; then
            echo "‚úÖ Posts API working (Status: $POSTS_STATUS)"
          else
            echo "‚ö†Ô∏è Posts API issue (Status: $POSTS_STATUS) - may use fallback data"
          fi
          
          # Partners API
          PARTNERS_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL/api/partners")
          if [ $PARTNERS_STATUS -eq 200 ]; then
            echo "‚úÖ Partners API working (Status: $PARTNERS_STATUS)"
          else
            echo "‚ö†Ô∏è Partners API issue (Status: $PARTNERS_STATUS) - may use fallback data"
          fi
          
          # Themes API
          THEMES_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL/api/themes/active")
          if [ $THEMES_STATUS -eq 200 ]; then
            echo "‚úÖ Themes API working (Status: $THEMES_STATUS)"
          else
            echo "‚ö†Ô∏è Themes API issue (Status: $THEMES_STATUS) - may use fallback themes"
          fi
          
          echo ""
          echo "üéâ Health check completed!"

  # ==========================================
  # DEPLOYMENT SUCCESS NOTIFICATION
  # ==========================================
  notify-success:
    name: üì£ Notify Success
    runs-on: ubuntu-latest
    needs: [health-check]
    if: success() && github.ref == 'refs/heads/main-for-vercel'
    
    steps:
      - name: üéâ Deployment Success
        run: |
          echo "üéâ DEPLOYMENT SUCCESSFUL!"
          echo "========================="
          echo "‚úÖ Build completed"
          echo "‚úÖ Tests passed"
          echo "‚úÖ Security checks passed"
          echo "‚úÖ Production deployment completed"
          echo "‚úÖ Health checks passed"
          echo ""
          echo "üåê Site URL: https://lovas-political-site-fixed-80xah7hpe.vercel.app"
          echo "üìä Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"